<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - TutorIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for dark theme */
        body {
            background-color: #1a1a1a; /* Dark background */
            color: #e0e0e0; /* Light text for contrast */
            font-family: 'Inter', sans-serif;
            display: flex; /* Make body a flex container */
            flex-direction: column; /* Arrange children vertically */
            min-height: 100vh; /* Ensure body takes full viewport height */
        }
        /* Form elements styling */
        .form-label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #d1d5db; /* gray-300 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .form-input, .form-select, .form-textarea {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* border border-gray-600 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            color: #ffffff; /* text-white */
            outline: none; /* focus:outline-none */
            transition: all 200ms ease-in-out; /* transition-all duration-200 */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 1px #3b82f6; /* focus:ring-1 focus:ring-blue-500 */
        }
        .form-checkbox {
            height: 1rem; /* h-4 */
            width: 1rem; /* w-4 */
            color: #3b82f6; /* text-blue-500 */
            border-color: #4b5563; /* border-gray-600 */
            border-radius: 0.25rem; /* rounded */
            background-color: #374151; /* bg-gray-700 */
            outline: none; /* focus:outline-none */
        }
        .form-checkbox:focus {
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); /* focus:ring-blue-500 */
        }
        .help-text {
            margin-top: 0.125rem; /* mt-0.5 */
            font-size: 0.75rem; /* text-xs */
            color: #9ca3af; /* gray-400 */
            opacity: 0.8; /* opacity-80 */
        }
        .card {
            background-color: #374151; /* bg-gray-800 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: box-shadow 300ms ease-in-out; /* transition-shadow duration-300 */
            border: 1px solid #4b5563; /* border border-gray-700 */
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* hover:shadow-xl */
        }
        .btn {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-width: 1px; /* border */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            outline: none; /* focus:outline-none */
        }
        .btn:focus {
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5), 0 0 0 4px rgba(0, 0, 0, 0.5); /* focus:ring-2 focus:ring-offset-2 */
        }
        .btn-primary {
            border-color: transparent; /* border-transparent */
            color: #ffffff; /* text-white */
            background-color: #2563eb; /* bg-blue-600 */
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        .btn-primary:focus {
            box-shadow: 0 0 0 2px #3b82f6, 0 0 0 4px #1f2937; /* focus:ring-blue-500 focus:ring-offset-gray-800 */
        }
        .btn-secondary {
            border-color: #4b5563; /* border-gray-600 */
            color: #d1d5db; /* text-gray-300 */
            background-color: #374151; /* bg-gray-700 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* hover:bg-gray-600 */
        }
        .btn-secondary:focus {
            box-shadow: 0 0 0 2px #6366f1, 0 0 0 4px #1f2937; /* focus:ring-indigo-500 focus:ring-offset-gray-800 */
        }
        .slider-track {
            -webkit-appearance: none;
            width: 100%; /* w-full */
            height: 0.5rem; /* h-2 */
            background-color: #4b5563; /* bg-gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .slider-thumb {
            -webkit-appearance: none;
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            background-color: #2563eb; /* bg-blue-600 */
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem; /* p-2 */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 200ms ease-in-out, color 200ms ease-in-out; /* transition-colors duration-200 */
        }
        .sidebar-nav-item.active {
            background-color: #4b5563; /* bg-gray-700 */
            color: #ffffff; /* text-white */
        }
        .sidebar-nav-item:not(.active) {
            color: #9ca3af; /* text-gray-400 */
        }
        .sidebar-nav-item:not(.active):hover {
            background-color: #4b5563; /* hover:bg-gray-700 */
            color: #ffffff; /* hover:text-white */
        }
        .content-panel {
            display: none;
        }
        .content-panel.active {
            display: block;
            display: flex; /* Ensure flex for inner tabs */
            flex-direction: column; /* Stack children vertically */
            width: 100%;
        }
        /* New sidebar specific styles */
        .left-sidebar {
            width: 250px; /* Default width */
            transition: width 0.3s ease-in-out;
            flex-shrink: 0; /* Prevent shrinking */
	    border-top: 1px solid #374151;
        }
        .left-sidebar.collapsed {
            width: 60px; /* Collapsed width */
        }
        .left-sidebar .text-hidden {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        .left-sidebar.collapsed .text-hidden {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        .left-sidebar-toggle-button {
            position: absolute;
            top: 50%;
            right: -12px; /* Half of button width */
            transform: translateY(-50%);
            z-index: 10;
        }
        /* Dropdown styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #374151;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            min-width: 150px; /* Increased width for better spacing */
            z-index: 50;
            overflow: hidden; /* Ensures rounded corners apply to children */
        }
        .dropdown-menu.active {
            display: block;
        }
        .dropdown-item {
            padding: 0.75rem 1rem; /* Increased padding */
            color: #e0e0e0;
            cursor: pointer;
            transition: background-color 200ms ease-in-out;
            border-bottom: 1px solid #4b5563; /* Subtle separator */
        }
        .dropdown-item:hover {
            background-color: #4b5563; /* Slightly darker on hover */
            color: #ffffff;
        }
        .dropdown-item:first-child {
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }
        .dropdown-item:last-child {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border-bottom: none; /* No border on the last item */
        }

        /* Metadata chip styles */
        .metadata-chip {
            display: inline-flex;
            align-items: center;
            background-color: #4b5563; /* gray-600 */
            color: #ffffff;
            padding: 0.3rem 0.6rem;
            border-radius: 9999px; /* full rounded */
            font-size: 0.75rem; /* text-xs */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .metadata-chip .remove-chip-btn {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            transition: color 200ms ease-in-out;
        }
        .metadata-chip .remove-chip-btn:hover {
            color: #ef4444; /* red-500 */
        }
        /* Styling for deactivated documents */
        .document-inactive {
            opacity: 0.5;
            text-decoration: line-through;
        }
    </style>
</head>
<body class="text-gray-200 flex min-h-screen flex-col">

    <div id="toast" class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 invisible transition-all duration-500 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Modal for Add Model -->
    <div id="add-model-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-semibold text-white mb-4">A√±adir Nuevo Modelo</h3>
            <input type="text" id="new-model-input" class="form-input mb-4" placeholder="Nombre del modelo">
            <div class="flex justify-end space-x-4">
                <button id="cancel-add-model" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-add-model" class="btn btn-primary">A√±adir</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Add/Edit Document -->
    <div id="add-document-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-xl border border-gray-700"> <!-- Increased max-w-xl -->
            <h3 id="document-modal-title" class="text-xl font-semibold text-white mb-4">Agregar Nuevo Documento</h3>
            <div class="space-y-4">
                <div id="document-file-input-group">
                    <label for="new-document-file" class="form-label">Documento</label>
                    <input type="file" id="new-document-file" class="form-input" accept=".pdf,.doc,.docx,.txt,.json,.csv">
                    <p class="help-text">Formatos soportados: PDF, DOCX, TXT, JSON, CSV</p>
                </div>
                <div id="document-name-display-group" class="hidden">
                    <label for="document-name-display" class="form-label">Nombre del Documento</label>
                    <input type="text" id="document-name-display" class="form-input bg-gray-700 text-gray-400 cursor-not-allowed" readonly>
                </div>
                <div class="border border-gray-700 p-4 rounded-md">
                    <h4 class="text-md font-medium text-gray-300 mb-3">Agregar Metadata</h4>
                    <div class="flex space-x-2 items-center mb-3">
                        <!-- Key input/select area - now using w-full on both and toggling hidden -->
                        <select id="new-metadata-key-select" class="form-select w-full">
                            <option value="" disabled selected hidden>Seleccionar metadata existente</option>
                            <option value="new-metadata-key">Agregar nueva...</option>
                            <!-- Existing metadata keys will be populated here by JS -->
                        </select>
                        <input type="text" id="new-metadata-key-input" class="form-input w-full hidden" placeholder="Nueva clave de metadata">
                        
                        <!-- Value input -->
                        <input type="text" id="new-metadata-value-input" class="form-input flex-grow" placeholder="Valor de la metadata">
                        <!-- Add button -->
                        <button id="add-metadata-btn" class="btn btn-primary px-3 py-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                        <!-- NEW: Reset Metadata Input Button -->
                        <button id="reset-metadata-input-btn" class="btn btn-secondary px-3 py-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12v.622m15.356-2A8.001 8.001 0 0120 12v.622m-2.489 4.414l-2.489 2.489m0 0l-2.489-2.489m2.489 2.489V10" />
                            </svg>
                        </button>
                    </div>
                    <div id="metadata-chips-container" class="mt-4 flex flex-wrap gap-2">
                        <!-- Metadata chips will be added here by JS -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-add-document" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-add-document" class="btn btn-primary">Agregar Documento</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel Header -->
    <header class="bg-gray-900 p-4 shadow-md">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="text-xl font-bold text-gray-100">TutorIA</h1>
            </div>
            <div class="flex items-center space-x-4 relative">
                <!-- Settings icon and Dropdown Toggle -->
                <div class="relative">
                    <svg id="settings-icon-toggle" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 cursor-pointer hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.307 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div id="settings-dropdown-menu" class="dropdown-menu">
                        <a href="#" id="dropdown-profile" class="dropdown-item">Perfil</a>
                        <a href="#" id="dropdown-configuracion" class="dropdown-item">Configuraci√≥n</a>
                        <a href="#" id="dropdown-logout" class="dropdown-item">Salir</a>
                    </div>
                </div>

                <!-- User icon (no dropdown) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 cursor-pointer hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-grow flex overflow-hidden relative">
        <!-- New Left Sidebar -->
        <aside id="left-sidebar" class="left-sidebar bg-gray-900 text-gray-300 p-4 flex flex-col relative">
            <div class="flex items-center mb-6">
                <button id="toggle-left-sidebar" class="left-sidebar-toggle-button bg-gray-700 hover:bg-gray-600 text-white rounded-full p-1 focus:outline-none">
                    <svg id="toggle-icon-open" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    <svg id="toggle-icon-close" class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <nav class="flex-grow space-y-2">
                <a href="#" id="nav-gestion-usuarios" class="flex items-center p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span class="text-hidden">Gesti√≥n de usuarios</span>
                </a>
                <!-- NEW: Gesti√≥n de documentos main navigation item -->
                <a href="#" id="nav-gestion-documentos-nuevo" class="flex items-center p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7 7-7M19 10v10a1 1 0 001 1h3m-10-9v2m0 0v2m0 0v2m0 0v2" />
                    </svg>
                    <span class="text-hidden">Gesti√≥n de documentos</span>
                </a>
                <a href="#" id="nav-chatear-bot" class="flex items-center p-2 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    <span class="text-hidden">Chatear con Bot</span>
                </a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-700 flex items-center">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">NU</div>
                <span class="ml-3 text-hidden">Nombre de usuario</span>
            </div>
        </aside>

        <div class="flex flex-grow bg-gray-800 shadow-lg border border-gray-700 overflow-hidden w-full">
            <!-- Main Content Area -->
            <main class="flex-grow p-6 overflow-y-auto pb-20">
                <!-- Main Content Panels -->
                <!-- Panel de Gesti√≥n de Usuarios -->
                <div id="panel-gestion-usuarios" style="height: calc(100vh - 250px);" class="content-panel">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üìä Gesti√≥n de usuarios</h3>
                    <p class="text-gray-400">Contenido de Gesti√≥n de usuarios.</p>
                </div>

                <!-- NEW: Panel de Gesti√≥n de Documentos (totalmente nuevo) -->
                <div id="panel-gestion-documentos-nuevo" style="height: calc(100vh - 250px);" class="content-panel active">
                    <!-- Horizontal Tabs for Document Management Sub-panels -->
                    <div class="flex border-b border-gray-700 mb-6 px-6 pt-4 -mx-6"> <!-- Negative margin to align with main content padding -->
                        <button id="doc-tab-upload" class="px-4 py-2 text-white font-semibold border-b-2 border-blue-500 transition-colors duration-200">Carga de Documentos</button>
                        <button id="doc-tab-web-scraping" class="px-4 py-2 text-gray-400 font-semibold hover:text-white border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">Web Scraping</button>
                    </div>

                    <!-- Document Management Content Panels -->
                    <div class="flex-grow px-6" style="overflow: auto;">
                        <!-- Carga de Documentos Panel -->
                        <div id="doc-panel-upload" class="content-panel active">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-medium text-gray-300 font-bold">üìö Documentos Cargados</h4>
                                <div class="flex space-x-2">
                                    <button id="toggle-selection-mode-btn" class="btn btn-secondary px-3 py-1 text-sm flex items-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span>Seleccionar Documentos</span>
                                    </button>
                                    <button id="apply-changes-btn" class="btn btn-primary px-3 py-1 text-sm flex items-center space-x-1 hidden">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        <span>Aplicar Cambios</span>
                                    </button>
                                    <button id="add-new-document-btn" class="btn btn-primary px-3 py-1 text-sm flex items-center space-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        <span>Agregar</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filter and Document List -->
                            <div class="mb-4">
                                <input type="text" id="document-filter-input" class="form-input w-full" placeholder="Filtrar documentos...">
                            </div>
                            <div id="loaded-documents-list" class="space-y-4">
                                <!-- Loaded documents will be rendered here by JS -->
                            </div>
                        </div>

                        <!-- Web Scraping Panel (dentro de Gesti√≥n de documentos) -->
                        <div id="doc-panel-web-scraping" class="content-panel">
                            <h4 class="text-lg font-medium text-gray-300 mb-4 font-bold">üï∏Ô∏è Scrapear Contenido Web</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="web-scraping-url" class="form-label">URL a Scrapear</label>
                                    <input type="url" id="web-scraping-url" class="form-input" placeholder="https://www.example.com">
                                    <p class="help-text">Introduce la URL de la p√°gina web que deseas scrapear.</p>
                                </div>
                                <div>
                                    <label for="web-scraping-depth" class="form-label">Profundidad de Scrapeo (Nivel de enlaces)</label>
                                    <input type="number" id="web-scraping-depth" value="0" min="0" class="form-input">
                                    <p class="help-text">0 para solo la URL actual, 1 para incluir enlaces de la URL, etc.</p>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="include-images" class="form-label mb-0">Incluir Im√°genes</label>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="include-images" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                <button id="start-scraping-btn" class="btn btn-primary mt-4 w-full">Iniciar Scrapeo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Chatear con Bot -->
                <div id="panel-chatear-bot" style="height: calc(100vh - 250px);" class="content-panel">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üí¨ Chatear con Bot</h3>
                    <p class="text-gray-400">Contenido de Chatear con Bot.</p>
                </div>

                <!-- Panel de Configuraci√≥n (existing, unchanged) -->
                <div id="panel-configuracion" style="height: calc(100vh - 250px);" class="content-panel">
                    <div class="flex flex-col w-full">
                        <!-- New Horizontal Tabs for Settings Sub-panels -->
                        <div class="flex border-b border-gray-700 mb-6 px-6 pt-4">
                            <button id="sub-tab-general" class="px-4 py-2 text-white font-semibold border-b-2 border-blue-500 transition-colors duration-200">General</button>
                            <button id="sub-tab-usuarios" class="px-4 py-2 text-gray-400 font-semibold hover:text-white border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">Usuarios</button>
                            <button id="sub-tab-modelos" class="px-4 py-2 text-gray-400 font-semibold hover:text-white border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">Modelos</button>
                            <button id="sub-tab-ingesta" class="px-4 py-2 text-gray-400 font-semibold hover:text-white border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">Ingesta</button>
                            <button id="sub-tab-web-scraping" class="px-4 py-2 text-gray-400 font-semibold hover:text-white border-b-2 border-transparent hover:border-blue-500 transition-colors duration-200">Web Scraping</button>
                        </div>

                        <!-- Settings Content Panels -->
                        <div class="flex-grow px-6" style="overflow: auto;">
                            <!-- General Panel -->
                            <div id="settings-panel-general" class="content-panel active">
                                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">ü§ñ Configuraci√≥n General</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label for="enable-signups" class="form-label mb-0">Habilitar Registro de nuevos usuarios</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="enable-signups" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div>
                                        <label for="default-user-role" class="form-label">Rol de Usuario por Defecto</label>
                                        <select id="default-user-role" class="form-select">
                                            <option>Consulta</option>
                                            <option>Administrador</option>
                                        </select>
                                        <p class="help-text">Define el rol asignado a los nuevos usuarios registrados.</p>
                                    </div>
                                    
                                    <div>
                                        <label for="jwt-expiration" class="form-label">Expiraci√≥n JWT</label>
                                        <input type="number" id="jwt-expiration" value="-1" class="form-input" placeholder="-1">
                                        <p class="help-text">Unidades de tiempo v√°lidas: 's' (segundos), 'm' (minutos), 'h' (horas), 'd' (d√≠as), 'w' (semanas) o '-1' para sin expiraci√≥n.</p>
                                    </div>
                                    <div>
                                        <label for="webhook-url" class="form-label">URL de Webhook</label>
                                        <input type="url" id="webhook-url" class="form-input" placeholder="https://example.com/webhook">
                                        <p class="help-text">URL para enviar notificaciones autom√°ticas.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Usuarios Panel -->
                            <div id="settings-panel-usuarios" class="content-panel">
                                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üë• Permisos de Usuario</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label for="allow-chat-deletion" class="form-label mb-0">Permitir Eliminaci√≥n de Chat</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="allow-chat-deletion" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label for="save-private-data" class="form-label mb-0">Guardar datos privados</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="save-private-data" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Modelos Panel -->
                            <div id="settings-panel-modelos" class="content-panel">
                                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üß† Configuraci√≥n de Modelos</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="default-model" class="form-label">Modelo por Defecto</label>
                                        <select id="default-model" class="form-select">
                                            <option>Selecciona un modelo</option>
                                            <option>gpt-3.5-turbo</option>
                                            <option>gpt-4o</option>
                                            <option>City Weather</option>
                                            <!-- Add more models dynamically if needed -->
                                        </select>
                                        <p class="help-text">Modelo de IA predeterminado para nuevas interacciones.</p>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <label for="model-whitelisting-toggle" class="form-label mb-0">Lista Blanca de Modelos</label>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="model-whitelisting-toggle" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                        <div id="model-whitelist-container" class="space-y-2 p-4 bg-gray-700 rounded-md">
                                            <!-- Model whitelist items will be added here by JS -->
                                        </div>
                                        <button id="add-model-to-whitelist" class="btn btn-secondary mt-2">A√±adir Modelo</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Ingesta Panel -->
                            <div id="settings-panel-ingesta" class="content-panel">
                                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üì• Configuraci√≥n de Ingesta</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <section class="space-y-4 col-span-2">
                                        <h4 class="text-lg font-medium text-gray-300 font-bold">Base de Datos Vectorial</h4>
                                        <div>
                                            <label for="vector-db-client" class="form-label">Cliente de Base de Datos Vectorial</label>
                                            <select id="vector-db-client" class="form-select">
                                                <option>Qdrant</option>
                                                <option>Pinecone</option>
                                                <option>Weaviate</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="db-connection-url" class="form-label">URL de Conexi√≥n</label>
                                            <input type="text" id="db-connection-url" class="form-input" placeholder="ej. http://localhost:6333">
                                        </div>
                                        <div>
                                            <label for="db-access-token" class="form-label">Access Token</label>
                                            <input type="password" id="db-access-token" class="form-input" placeholder="****************">
                                        </div>
                                        <div>
                                            <label for="db-collection-name" class="form-label">Colecci√≥n de Datos</label>
                                            <input type="text" id="db-collection-name" class="form-input" placeholder="ej. my_collection">
                                        </div>
                                        <div>
                                            <label for="optimization-scenario" class="form-label">Escenario de Optimizaci√≥n</label>
                                            <select id="optimization-scenario" class="form-select">
                                                <option>Balanced</option>
                                                <option>High Precision</option>
                                                <option>High Recall</option>
                                            </select>
                                            <p class="help-text">Define el equilibrio entre velocidad y precisi√≥n de la b√∫squeda.</p>
                                        </div>
                                        <div>
                                            <label for="hnsw-ef" class="form-label">N√∫mero de Vecinos (hnsw_ef)</label>
                                            <input type="number" id="hnsw-ef" value="200" class="form-input" placeholder="ej. 100-500">
                                            <p class="help-text">Controla la profundidad de la b√∫squeda en el grafo HNSW.</p>
                                        </div>
                                        <div>
                                            <label for="retrieve-fragments" class="form-label">Fragmentos a Recuperar (k)</label>
                                            <input type="number" id="retrieve-fragments" value="5" class="form-input" placeholder="ej. 1-10">
                                            <p class="help-text">Cantidad de fragmentos de documentos m√°s relevantes a recuperar.</p>
                                        </div>
                                        <div class="flex items-center pt-2">
                                            <input id="exact-search" type="checkbox" class="form-checkbox">
                                            <label for="exact-search" class="ml-2 block text-sm text-gray-300">Habilitar B√∫squeda Exacta</label>
                                        </div>
                                        <p class="help-text -mt-3">Si est√° marcada, la b√∫squeda ser√° m√°s precisa pero potencialmente m√°s lenta.</p>
                                    </section>

                                    <section class="space-y-4 col-span-2">
                                        <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">Configuraci√≥n de B√∫squeda</h3>
                                        <div>
                                            <label for="splitter-type" class="form-label">Tipo de Divisor</label>
                                            <select id="splitter-type" class="form-select">
                                                <option>TokenTextSplitter</option>
                                                <option>RecursiveCharacterTextSplitter</option>
                                            </select>
                                            <p class="help-text">M√©todo para dividir el texto en fragmentos (chunks).</p>
                                        </div>
                                        <div>
                                            <label for="chunk-size" class="form-label">Tama√±o del Fragmento (Tokens)</label>
                                            <input type="number" id="chunk-size" value="1024" class="form-input">
                                            <p class="help-text">N√∫mero m√°ximo de tokens por fragmento.</p>
                                        </div>
                                        <div>
                                            <label for="chunk-overlap" class="form-label">Solapamiento (Tokens)</label>
                                            <input type="number" id="chunk-overlap" value="200" class="form-input">
                                            <p class="help-text">Tokens que se solapan entre fragmentos para mantener contexto.</p>
                                        </div>
                                    </section>
                                </div>
                            </div>

                            <!-- Web Scraping Panel -->
                            <div id="settings-panel-web-scraping" class="content-panel">
                                <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-blue-400 font-bold">üåê Configuraci√≥n de Web Scraping</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label for="enable-web-search" class="form-label mb-0">Habilitar B√∫squeda Web</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="enable-web-search" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div>
                                        <label for="web-search-engine" class="form-label">Motor de B√∫squeda Web</label>
                                        <select id="web-search-engine" class="form-select">
                                            <option>duckduckgo</option>
                                            <option>google</option>
                                            <option>bing</option>
                                        </select>
                                        <p class="help-text">Selecciona el motor de b√∫squeda a utilizar para el scraping web.</p>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="search-result-count" class="form-label">Conteo de Resultados de B√∫squeda</label>
                                            <input type="number" id="search-result-count" value="3" class="form-input">
                                            <p class="help-text">N√∫mero de resultados a recuperar por b√∫squeda.</p>
                                        </div>
                                        <div>
                                            <label for="concurrent-requests" class="form-label">Solicitudes Concurrentes</label>
                                            <input type="number" id="concurrent-requests" value="10" class="form-input">
                                            <p class="help-text">N√∫mero de solicitudes web simult√°neas.</p>
                                        </div>
                                    </div>
                                    <h4 class="text-lg font-medium text-gray-300 mt-6 mb-2 font-bold">Configuraci√≥n del Cargador Web</h4>
                                    <div class="flex items-center justify-between">
                                        <label for="bypass-ssl-verification" class="form-label mb-0">Omitir verificaci√≥n SSL para Sitios Web</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="bypass-ssl-verification" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div>
                                        <label for="youtube-language" class="form-label">Idioma</label>
                                        <input type="text" id="youtube-language" value="en" class="form-input">
                                        <p class="help-text">Idioma para la carga de contenido de YouTube (ej. 'es', 'en').</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fixed Save/Reset Buttons -->
                <div class="fixed bottom-4 right-4 p-4 bg-gray-800 rounded-lg shadow-xl z-40 flex space-x-4">
                    <button id="reset-button" class="btn btn-secondary">Restablecer</button>
                    <button id="save-button" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                // Left Sidebar
                leftSidebar: document.getElementById('left-sidebar'),
                toggleLeftSidebarButton: document.getElementById('toggle-left-sidebar'),
                toggleIconOpen: document.getElementById('toggle-icon-open'),
                toggleIconClose: document.getElementById('toggle-icon-close'),
                leftSidebarTextElements: document.querySelectorAll('#left-sidebar .text-hidden'),

                // Main Navigation items in Left Sidebar
                navGestionUsuarios: document.getElementById('nav-gestion-usuarios'),
                navGestionDocumentos: document.getElementById('nav-gestion-documentos'), // Original, unused
                navGestionDocumentosNuevo: document.getElementById('nav-gestion-documentos-nuevo'), // NEW
                navChatearBot: document.getElementById('nav-chatear-bot'),

                // Header Icons and Dropdown
                settingsIconToggle: document.getElementById('settings-icon-toggle'),
                settingsDropdownMenu: document.getElementById('settings-dropdown-menu'),
                userIcon: document.querySelector('header .flex.items-center.space-x-4 > svg:nth-child(2)'),
                dropdownProfile: document.getElementById('dropdown-profile'),
                dropdownConfiguracion: document.getElementById('dropdown-configuracion'),
                dropdownLogout: document.getElementById('dropdown-logout'),

                // Main Content Panels
                panelGestionUsuarios: document.getElementById('panel-gestion-usuarios'),
                panelGestionDocumentos: document.getElementById('panel-gestion-documentos'), // Original, unused
                panelGestionDocumentosNuevo: document.getElementById('panel-gestion-documentos-nuevo'), // NEW
                panelChatearBot: document.getElementById('panel-chatear-bot'),
                panelConfiguracion: document.getElementById('panel-configuracion'),

                // NEW: Document Management Sub-panels (content within the new Gesti√≥n de documentos panel)
                docSubTabs: {
                    upload: document.getElementById('doc-tab-upload'),
                    webScraping: document.getElementById('doc-tab-web-scraping'),
                },
                docContentPanels: {
                    upload: document.getElementById('doc-panel-upload'),
                    webScraping: document.getElementById('doc-panel-web-scraping'),
                },

                // Settings Sub-panels (content within the Configuraci√≥n panel)
                settingsSubTabs: {
                    general: document.getElementById('sub-tab-general'),
                    usuarios: document.getElementById('sub-tab-usuarios'),
                    modelos: document.getElementById('sub-tab-modelos'),
                    ingesta: document.getElementById('sub-tab-ingesta'),
                    webScraping: document.getElementById('sub-tab-web-scraping'),
                },
                settingsContentPanels: { // Reference to the actual content divs for settings sub-panels
                    general: document.getElementById('settings-panel-general'),
                    usuarios: document.getElementById('settings-panel-usuarios'),
                    modelos: document.getElementById('settings-panel-modelos'),
                    ingesta: document.getElementById('settings-panel-ingesta'),
                    webScraping: document.getElementById('settings-panel-web-scraping'),
                },

                // Form elements for data (existing)
                enableSignups: document.getElementById('enable-signups'),
                defaultUserRole: document.getElementById('default-user-role'),
                jwtExpiration: document.getElementById('jwt-expiration'),
                webhookUrl: document.getElementById('webhook-url'),
                allowChatDeletion: document.getElementById('allow-chat-deletion'),
                savePrivateData: document.getElementById('save-private-data'),
                defaultModel: document.getElementById('default-model'),
                modelWhitelistingToggle: document.getElementById('model-whitelisting-toggle'),
                modelWhitelistContainer: document.getElementById('model-whitelist-container'),
                addModelToWhitelistButton: document.getElementById('add-model-to-whitelist'),
                addModelModal: document.getElementById('add-model-modal'),
                newModelInput: document.getElementById('new-model-input'),
                cancelAddModelButton: document.getElementById('cancel-add-model'),
                confirmAddModelButton: document.getElementById('confirm-add-model'),
                
                // Ingesta fields (existing)
                vectorDbClient: document.getElementById('vector-db-client'),
                dbConnectionUrl: document.getElementById('db-connection-url'),
                dbAccessToken: document.getElementById('db-access-token'),
                dbCollectionName: document.getElementById('db-collection-name'),
                optimizationScenario: document.getElementById('optimization-scenario'),
                hnswEf: document.getElementById('hnsw-ef'),
                retrieveFragments: document.getElementById('retrieve-fragments'),
                exactSearch: document.getElementById('exact-search'),
                splitterType: document.getElementById('splitter-type'),
                chunkSize: document.getElementById('chunk-size'),
                chunkOverlap: document.getElementById('chunk-overlap'),

                // Web Scraping fields (existing)
                enableWebSearch: document.getElementById('enable-web-search'),
                webSearchEngine: document.getElementById('web-search-engine'),
                searchResultCount: document.getElementById('search-result-count'),
                concurrentRequests: document.getElementById('concurrent-requests'),
                bypassSslVerification: document.getElementById('bypass-ssl-verification'),
                youtubeLanguage: document.getElementById('youtube-language'),

                // NEW: Document Upload and Web Scraping fields
                webScrapingUrl: document.getElementById('web-scraping-url'),
                webScrapingDepth: document.getElementById('web-scraping-depth'),
                includeImages: document.getElementById('include-images'),
                startScrapingBtn: document.getElementById('start-scraping-btn'),

                // NEW: Document List and Add Document Modal elements
                addNewDocumentBtn: document.getElementById('add-new-document-btn'),
                toggleSelectionModeBtn: document.getElementById('toggle-selection-mode-btn'), // NEW
                applyChangesBtn: document.getElementById('apply-changes-btn'), // NEW
                documentFilterInput: document.getElementById('document-filter-input'),
                loadedDocumentsList: document.getElementById('loaded-documents-list'),
                addDocumentModal: document.getElementById('add-document-modal'),
                documentModalTitle: document.getElementById('document-modal-title'), // NEW
                documentFileInputGroup: document.getElementById('document-file-input-group'), // NEW
                documentNameDisplayGroup: document.getElementById('document-name-display-group'), // NEW
                documentNameDisplay: document.getElementById('document-name-display'), // NEW
                newDocumentFileInput: document.getElementById('new-document-file'),
                newMetadataKeySelect: document.getElementById('new-metadata-key-select'),
                newMetadataKeyInput: document.getElementById('new-metadata-key-input'),
                newMetadataValueInput: document.getElementById('new-metadata-value-input'),
                addMetadataBtn: document.getElementById('add-metadata-btn'),
                resetMetadataInputBtn: document.getElementById('reset-metadata-input-btn'), // NEW
                metadataChipsContainer: document.getElementById('metadata-chips-container'),
                cancelAddDocumentBtn: document.getElementById('cancel-add-document'),
                confirmAddDocumentBtn: document.getElementById('confirm-add-document'),


                // Global
                saveButton: document.getElementById('save-button'),
                resetButton: document.getElementById('reset-button'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
            };

            // Log all elements to check if any are null
            console.log('Verificando elementos HTML:');
            for (const key in elements) {
                if (elements.hasOwnProperty(key)) {
                    if (typeof elements[key] === 'object' && elements[key] !== null && !Array.isArray(elements[key])) {
                        // For nested objects like settingsSubTabs or settingsContentPanels
                        for (const subKey in elements[key]) {
                            if (elements[key].hasOwnProperty(subKey)) {
                                console.log(`  elements.${key}.${subKey}:`, elements[key][subKey]);
                            }
                        }
                    } else {
                        console.log(`  elements.${key}:`, elements[key]);
                    }
                }
            }

            const defaultConfig = {
                // General
                enableSignups: true,
                defaultUserRole: 'Consulta',
                jwtExpiration: -1,
                webhookUrl: 'https://example.com/webhook',

                // Users
                allowChatDeletion: true,
                savePrivateData: true,
                
                // Models
                defaultModel: 'gpt-3.5-turbo',
                modelWhitelisting: ['gpt-3.5-turbo', 'gpt-4o', 'City Weather'],

                // Ingesta
                vectorDbClient: 'Qdrant',
                dbConnectionUrl: 'http://localhost:6333',
                dbAccessToken: '',
                dbCollectionName: 'my_collection',
                optimizationScenario: 'Balanced',
                hnswEf: 200,
                retrieveFragments: 5,
                exactSearch: false,
                splitterType: 'TokenTextSplitter',
                chunkSize: 1024,
                chunkOverlap: 200,

                // Web Scraping (original settings)
                enableWebSearch: true,
                webSearchEngine: 'duckduckgo',
                searchResultCount: 3,
                concurrentRequests: 10,
                bypassSslVerification: true,
                youtubeLanguage: 'en',

                // NEW Document Management defaults
                webScrapingDepth: 0,
                includeImages: false,
            };

            let currentModelWhitelist = [...defaultConfig.modelWhitelisting];

            // Mock data for loaded documents
            let loadedDocuments = [
                { id: 1, name: 'Contrato de Servicio V1.0', description: 'Documento legal que detalla los t√©rminos del servicio.', metadata: { tipo: 'legal', version: '1.0' }, status: 'active' },
                { id: 2, name: 'Manual de Usuario App M√≥vil', description: 'Gu√≠a completa para el uso de la aplicaci√≥n m√≥vil.', metadata: { categoria: 'manual', plataforma: 'm√≥vil' }, status: 'active' },
                { id: 3, name: 'Especificaciones T√©cnicas Proyecto Alpha', description: 'Detalles t√©cnicos del desarrollo del Proyecto Alpha.', metadata: { proyecto: 'Alpha', fase: 'desarrollo' }, status: 'active' },
                { id: 4, name: 'Pol√≠ticas de Privacidad Actualizadas', description: 'Revisi√≥n y actualizaci√≥n de las pol√≠ticas de privacidad de la empresa.', metadata: { tipo: 'pol√≠tica', fecha_revision: '2023-06-15' }, status: 'active' },
            ];

            // Temporary array to hold metadata for the document being added/edited in the modal
            let currentDocumentMetadata = {};
            let editingDocId = null; // Stores the ID of the document being edited, null for new document
            let selectionMode = false; // NEW: State for document selection mode

            function showToast(message, isError = false) {
                elements.toastMessage.textContent = message;
                elements.toast.classList.remove('bg-green-600', 'bg-red-600');
                elements.toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                elements.toast.classList.remove('invisible', 'opacity-0');
                
                setTimeout(() => {
                    elements.toast.classList.add('invisible', 'opacity-0');
                }, 3000);
            }

            function renderModelWhitelist() {
                elements.modelWhitelistContainer.innerHTML = '';
                if (elements.modelWhitelistingToggle.checked) {
                    currentModelWhitelist.forEach((model) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-gray-600 p-2 rounded-md';
                        div.innerHTML = `
                            <span class="text-sm">${model}</span>
                            <button data-model="${model}" class="remove-model-btn text-red-400 hover:text-red-600 transition-colors duration-200">
                                &times;
                            </button>
                        `;
                        elements.modelWhitelistContainer.appendChild(div);
                    });
                }
            }

            function addModelToWhitelist() {
                const newModel = elements.newModelInput.value.trim();
                if (newModel && !currentModelWhitelist.includes(newModel)) {
                    currentModelWhitelist.push(newModel);
                    renderModelWhitelist();
                    elements.newModelInput.value = ''; // Clear input
                    elements.addModelModal.classList.add('hidden'); // Hide modal
                } else if (newModel) {
                    showToast('El modelo ya existe en la lista.', true);
                }
            }

            function removeModelFromWhitelist(event) {
                const modelToRemove = event.target.dataset.model;
                currentModelWhitelist = currentModelWhitelist.filter(model => model !== modelToRemove);
                renderModelWhitelist();
            }

            function saveConfiguration() {
                const currentConfig = {
                    // General
                    enableSignups: elements.enableSignups.checked,
                    defaultUserRole: elements.defaultUserRole.value,
                    jwtExpiration: parseInt(elements.jwtExpiration.value, 10),
                    webhookUrl: elements.webhookUrl.value,

                    // Users
                    allowChatDeletion: elements.allowChatDeletion.checked,
                    savePrivateData: elements.savePrivateData.checked,
                    
                    // Models
                    defaultModel: elements.defaultModel.value,
                    modelWhitelisting: elements.modelWhitelistingToggle.checked ? currentModelWhitelist : [],

                    // Ingesta
                    vectorDbClient: elements.vectorDbClient ? elements.vectorDbClient.value : undefined,
                    dbConnectionUrl: elements.dbConnectionUrl ? elements.dbConnectionUrl.value : undefined,
                    dbAccessToken: elements.dbAccessToken ? elements.dbAccessToken.value : undefined,
                    dbCollectionName: elements.dbCollectionName ? elements.dbCollectionName.value : undefined,
                    optimizationScenario: elements.optimizationScenario ? elements.optimizationScenario.value : undefined,
                    hnswEf: elements.hnswEf ? parseInt(elements.hnswEf.value, 10) : undefined,
                    retrieveFragments: elements.retrieveFragments ? parseInt(elements.retrieveFragments.value, 10) : undefined,
                    exactSearch: elements.exactSearch ? elements.exactSearch.checked : undefined,
                    splitterType: elements.splitterType ? elements.splitterType.value : undefined,
                    chunkSize: elements.chunkSize ? parseInt(elements.chunkSize.value, 10) : undefined,
                    chunkOverlap: elements.chunkOverlap ? parseInt(elements.chunkOverlap.value, 10) : undefined,

                    // Web Scraping (original settings panel)
                    enableWebSearch: elements.enableWebSearch ? elements.enableWebSearch.checked : undefined,
                    webSearchEngine: elements.webSearchEngine ? elements.webSearchEngine.value : undefined,
                    searchResultCount: elements.searchResultCount ? parseInt(elements.searchResultCount.value, 10) : undefined,
                    concurrentRequests: elements.concurrentRequests ? parseInt(elements.concurrentRequests.value, 10) : undefined,
                    bypassSslVerification: elements.bypassSslVerification ? elements.bypassSslVerification.checked : undefined,
                    youtubeLanguage: elements.youtubeLanguage ? elements.youtubeLanguage.value : undefined,

                    // NEW Document Management Data
                    docManagement: {
                        webScrapingUrl: elements.webScrapingUrl.value,
                        webScrapingDepth: parseInt(elements.webScrapingDepth.value, 10),
                        includeImages: elements.includeImages.checked,
                    }
                };
                
                console.log('Guardando configuraci√≥n:', currentConfig);
                showToast('Configuraci√≥n guardada exitosamente.');
            }

            function resetToDefaults() {
                // General
                if (elements.enableSignups) elements.enableSignups.checked = defaultConfig.enableSignups;
                if (elements.defaultUserRole) elements.defaultUserRole.value = defaultConfig.defaultUserRole;
                if (elements.jwtExpiration) elements.jwtExpiration.value = defaultConfig.jwtExpiration;
                if (elements.webhookUrl) elements.webhookUrl.value = defaultConfig.webhookUrl;

                // Users
                if (elements.allowChatDeletion) elements.allowChatDeletion.checked = defaultConfig.allowChatDeletion;
                if (elements.savePrivateData) elements.savePrivateData.checked = defaultConfig.savePrivateData;
                
                // Models
                if (elements.defaultModel) elements.defaultModel.value = defaultConfig.defaultModel;
                if (elements.modelWhitelistingToggle) elements.modelWhitelistingToggle.checked = true; // Assume whitelisting is enabled by default
                currentModelWhitelist = [...defaultConfig.modelWhitelisting];
                renderModelWhitelist(); // Re-render whitelist after reset
                
                // Ingesta
                if (elements.vectorDbClient) elements.vectorDbClient.value = defaultConfig.vectorDbClient;
                if (elements.dbConnectionUrl) elements.dbConnectionUrl.value = defaultConfig.dbConnectionUrl;
                if (elements.dbAccessToken) elements.dbAccessToken.value = defaultConfig.dbAccessToken;
                if (elements.dbCollectionName) elements.dbCollectionName.value = defaultConfig.dbCollectionName;
                if (elements.optimizationScenario) elements.optimizationScenario.value = defaultConfig.optimizationScenario;
                if (elements.hnswEf) elements.hnswEf.value = defaultConfig.hnswEf;
                if (elements.retrieveFragments) elements.retrieveFragments.value = defaultConfig.retrieveFragments;
                if (elements.exactSearch) elements.exactSearch.checked = defaultConfig.exactSearch;
                if (elements.splitterType) elements.splitterType.value = defaultConfig.splitterType;
                if (elements.chunkSize) elements.chunkSize.value = defaultConfig.chunkSize;
                if (elements.chunkOverlap) elements.chunkOverlap.value = defaultConfig.chunkOverlap;

                // Web Scraping (original settings panel)
                if (elements.enableWebSearch) elements.enableWebSearch.checked = defaultConfig.enableWebSearch;
                if (elements.webSearchEngine) elements.webSearchEngine.value = defaultConfig.webSearchEngine;
                if (elements.searchResultCount) elements.searchResultCount.value = defaultConfig.searchResultCount;
                if (elements.concurrentRequests) elements.concurrentRequests.value = defaultConfig.concurrentRequests;
                if (elements.bypassSslVerification) elements.bypassSslVerification.checked = defaultConfig.bypassSslVerification;
                if (elements.youtubeLanguage) elements.youtubeLanguage.value = defaultConfig.youtubeLanguage;

                // NEW Document Management Defaults
                if (elements.webScrapingUrl) elements.webScrapingUrl.value = ''; // Clear URL
                if (elements.webScrapingDepth) elements.webScrapingDepth.value = defaultConfig.webScrapingDepth;
                if (elements.includeImages) elements.includeImages.checked = defaultConfig.includeImages;

                // Clear document list and filter
                loadedDocuments = [
                    { id: 1, name: 'Contrato de Servicio V1.0', description: 'Documento legal que detalla los t√©rminos del servicio.', metadata: { tipo: 'legal', version: '1.0' }, status: 'active' },
                    { id: 2, name: 'Manual de Usuario App M√≥vil', description: 'Gu√≠a completa para el uso de la aplicaci√≥n m√≥vil.', metadata: { categoria: 'manual', plataforma: 'm√≥vil' }, status: 'active' },
                    { id: 3, name: 'Especificaciones T√©cnicas Proyecto Alpha', description: 'Detalles t√©cnicos del desarrollo del Proyecto Alpha.', metadata: { proyecto: 'Alpha', fase: 'desarrollo' }, status: 'active' },
                    { id: 4, name: 'Pol√≠ticas de Privacidad Actualizadas', description: 'Revisi√≥n y actualizaci√≥n de las pol√≠ticas de privacidad de la empresa.', metadata: { tipo: 'pol√≠tica', fecha_revision: '2023-06-15' }, status: 'active' },
                ]; // Reset to initial mock data
                selectionMode = false; // Reset selection mode on full reset
                renderLoadedDocuments();
                if (elements.documentFilterInput) elements.documentFilterInput.value = '';
                
                showToast('Configuraci√≥n restablecida a los valores predeterminados.', false);
            }

            function activateMainPanel(panelId) {
                // Remove 'active' class from all main navigation items in the sidebar
                const navItems = [
                    elements.navGestionUsuarios,
                    elements.navGestionDocumentosNuevo, // NEW
                    elements.navChatearBot
                ];
                navItems.forEach(item => {
                    if (item) item.classList.remove('active');
                });

                // Hide all main content panels
                const contentPanels = [
                    elements.panelGestionUsuarios,
                    elements.panelGestionDocumentosNuevo, // NEW
                    elements.panelChatearBot,
                    elements.panelConfiguracion
                ];
                contentPanels.forEach(panel => {
                    if (panel) panel.classList.remove('active');
                });

                // Activate selected main navigation item and content panel
                let activeNavItem;
                let activeContentPanel;

                switch (panelId) {
                    case 'panel-gestion-usuarios':
                        activeNavItem = elements.navGestionUsuarios;
                        activeContentPanel = elements.panelGestionUsuarios;
                        break;
                    case 'panel-gestion-documentos-nuevo': // NEW
                        activeNavItem = elements.navGestionDocumentosNuevo;
                        activeContentPanel = elements.panelGestionDocumentosNuevo;
                        // For the new section, default to the first sub-tab
                        activateDocSubPanel('upload');
                        break;
                    case 'panel-chatear-bot':
                        activeNavItem = elements.navChatearBot;
                        activeContentPanel = elements.panelChatearBot;
                        break;
                    case 'panel-configuracion':
                        activeContentPanel = elements.panelConfiguracion; // No specific nav item in sidebar for this
                        // For settings, ensure general tab is active by default
                        activateSettingsSubPanel('general');
                        break;
                    default:
                        console.error('Panel principal no reconocido:', panelId);
                        return;
                }

                if (activeNavItem) activeNavItem.classList.add('active');
                if (activeContentPanel) activeContentPanel.classList.add('active');

                // Close dropdown if it's open
                elements.settingsDropdownMenu.classList.remove('active');
            }

            function activateSettingsSubPanel(subPanelName) {
                // Remove 'active' class from all settings horizontal tabs
                for (const key in elements.settingsSubTabs) {
                    if (elements.settingsSubTabs.hasOwnProperty(key) && elements.settingsSubTabs[key]) {
                        elements.settingsSubTabs[key].classList.remove('border-blue-500', 'text-white');
                        elements.settingsSubTabs[key].classList.add('border-transparent', 'text-gray-400', 'hover:text-white');
                    }
                }

                // Hide all settings content panels
                for (const key in elements.settingsContentPanels) {
                    if (elements.settingsContentPanels.hasOwnProperty(key) && elements.settingsContentPanels[key]) {
                        elements.settingsContentPanels[key].classList.remove('active');
                    }
                }

                // Activate selected horizontal tab
                const activeSubTab = elements.settingsSubTabs[subPanelName];
                if (activeSubTab) {
                    activeSubTab.classList.add('border-blue-500', 'text-white');
                    activeSubTab.classList.remove('border-transparent', 'text-gray-400', 'hover:text-white');
                } else {
                    console.error('Pesta√±a de configuraci√≥n no encontrada para el panel:', subPanelName);
                }

                // Show the selected settings content panel
                const activeContentPanel = elements.settingsContentPanels[subPanelName];
                if (activeContentPanel) {
                    activeContentPanel.classList.add('active');
                } else {
                    console.error('Panel de contenido de settings no encontrado para el panel:', subPanelName);
                }
            }

            // NEW: Function to handle activating Document Management sub-panels
            function activateDocSubPanel(subPanelName) {
                // Remove 'active' class from all document management horizontal tabs
                for (const key in elements.docSubTabs) {
                    if (elements.docSubTabs.hasOwnProperty(key) && elements.docSubTabs[key]) {
                        elements.docSubTabs[key].classList.remove('border-blue-500', 'text-white');
                        elements.docSubTabs[key].classList.add('border-transparent', 'text-gray-400', 'hover:text-white');
                    }
                }

                // Hide all document management content panels
                for (const key in elements.docContentPanels) {
                    if (elements.docContentPanels.hasOwnProperty(key) && elements.docContentPanels[key]) {
                        elements.docContentPanels[key].classList.remove('active');
                    }
                }

                // Activate selected horizontal tab
                const activeSubTab = elements.docSubTabs[subPanelName];
                if (activeSubTab) {
                    activeSubTab.classList.add('border-blue-500', 'text-white');
                    activeSubTab.classList.remove('border-transparent', 'text-gray-400', 'hover:text-white');
                } else {
                    console.error('Pesta√±a de gesti√≥n de documentos no encontrada para el panel:', subPanelName);
                }

                // Show the selected document management content panel
                const activeContentPanel = elements.docContentPanels[subPanelName];
                if (activeContentPanel) {
                    activeContentPanel.classList.add('active');
                } else {
                    console.error('Panel de contenido de gesti√≥n de documentos no encontrado para el panel:', subPanelName);
                }
            }

            // Function to render loaded documents based on filter
            function renderLoadedDocuments() {
                if (!elements.loadedDocumentsList) return; // Ensure element exists

                const filterText = elements.documentFilterInput ? elements.documentFilterInput.value.toLowerCase() : '';
                elements.loadedDocumentsList.innerHTML = ''; // Clear existing list

                const filteredDocuments = loadedDocuments.filter(doc => {
                    const matchesName = doc.name.toLowerCase().includes(filterText);
                    const matchesDescription = doc.description.toLowerCase().includes(filterText);
                    const matchesMetadata = Object.keys(doc.metadata).some(key => 
                        key.toLowerCase().includes(filterText) || 
                        String(doc.metadata[key]).toLowerCase().includes(filterText)
                    );
                    return matchesName || matchesDescription || matchesMetadata;
                });

                if (filteredDocuments.length === 0) {
                    elements.loadedDocumentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No se encontraron documentos.</p>';
                    return;
                }

                filteredDocuments.forEach(doc => {
                    const docItem = document.createElement('div');
                    docItem.className = `bg-gray-700 p-4 rounded-lg shadow-sm flex items-center justify-between ${doc.status === 'inactive' ? 'document-inactive' : ''}`;
                    
                    let metadataDisplay = Object.keys(doc.metadata).map(key => `${key}: ${doc.metadata[key]}`).join(', ');
                    if (metadataDisplay) {
                        metadataDisplay = `<span class="text-xs text-gray-500">Metadata: ${metadataDisplay}</span>`;
                    } else {
                        metadataDisplay = `<span class="text-xs text-gray-500">Sin metadata</span>`;
                    }

                    docItem.innerHTML = `
                        <div class="flex items-center flex-grow">
                            ${selectionMode ? `<input type="checkbox" data-doc-id="${doc.id}" class="form-checkbox mr-3 document-select-checkbox">` : ''}
                            <div>
                                <p class="text-white font-semibold">${doc.name}</p>
                                <p class="text-gray-400 text-sm">${doc.description}</p>
                                ${metadataDisplay}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-doc-id="${doc.id}" class="text-blue-400 hover:text-blue-600 transition-colors duration-200 edit-doc-metadata-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                            <button data-doc-id="${doc.id}" class="text-red-400 hover:text-red-600 transition-colors duration-200 remove-loaded-doc-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    elements.loadedDocumentsList.appendChild(docItem);
                });

                // Add event listeners for remove buttons
                elements.loadedDocumentsList.querySelectorAll('.remove-loaded-doc-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docIdToRemove = parseInt(e.currentTarget.dataset.docId);
                        loadedDocuments = loadedDocuments.filter(doc => doc.id !== docIdToRemove);
                        renderLoadedDocuments(); // Re-render the list
                        showToast('Documento eliminado.', false);
                    });
                });

                // Add event listeners for edit metadata buttons
                elements.loadedDocumentsList.querySelectorAll('.edit-doc-metadata-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docIdToEdit = parseInt(e.currentTarget.dataset.docId);
                        openEditDocumentModal(docIdToEdit);
                    });
                });
            }

            // Function to populate metadata key select dropdown
            function populateMetadataKeySelect() {
                if (!elements.newMetadataKeySelect) return;

                const existingKeys = new Set();
                loadedDocuments.forEach(doc => {
                    Object.keys(doc.metadata).forEach(key => existingKeys.add(key));
                });

                // Clear existing options except "Seleccionar metadata existente" and "Agregar nueva..."
                elements.newMetadataKeySelect.innerHTML = `
                    <option value="" disabled selected hidden>Seleccionar metadata existente</option>
                    <option value="new-metadata-key">Agregar nueva...</option>
                `;

                Array.from(existingKeys).sort().forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    elements.newMetadataKeySelect.appendChild(option);
                });
            }

            // Function to render metadata chips in the modal
            function renderMetadataChips() {
                if (!elements.metadataChipsContainer) return;
                elements.metadataChipsContainer.innerHTML = '';
                Object.keys(currentDocumentMetadata).forEach(key => {
                    const chip = document.createElement('span');
                    chip.className = 'metadata-chip';
                    chip.innerHTML = `
                        ${key}: ${currentDocumentMetadata[key]}
                        <button type="button" data-key="${key}" class="remove-chip-btn">
                            &times;
                        </button>
                    `;
                    elements.metadataChipsContainer.appendChild(chip);
                });

                // Add event listeners to remove buttons on chips
                elements.metadataChipsContainer.querySelectorAll('.remove-chip-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const keyToRemove = e.target.dataset.key;
                        delete currentDocumentMetadata[keyToRemove];
                        renderMetadataChips();
                    });
                });
            }

            // Function to add a metadata chip from the modal inputs
            function addMetadataChip() {
                let key = elements.newMetadataKeySelect.value;
                const value = elements.newMetadataValueInput.value.trim();
                const newKeyInput = elements.newMetadataKeyInput.value.trim();

                // If "Agregar nueva..." is selected, use the text input for the key
                if (elements.newMetadataKeySelect.value === 'new-metadata-key') {
                    key = newKeyInput;
                }

                if (!key || !value) {
                    showToast('Por favor, selecciona o introduce una clave y un valor para la metadata.', true);
                    return;
                }

                if (currentDocumentMetadata.hasOwnProperty(key)) {
                    showToast(`La clave de metadata "${key}" ya existe.`, true);
                    return;
                }

                currentDocumentMetadata[key] = value;
                renderMetadataChips();

                // Reset inputs
                elements.newMetadataKeySelect.value = ''; // Reset to placeholder
                elements.newMetadataKeyInput.value = '';
                elements.newMetadataKeyInput.classList.add('hidden');
                elements.newMetadataKeySelect.classList.remove('hidden'); // Ensure select is visible again
                elements.newMetadataValueInput.value = '';
            }

            // Function to reset metadata input fields
            function resetMetadataInput() {
                elements.newMetadataKeySelect.value = ''; // Reset select to placeholder
                elements.newMetadataKeyInput.value = ''; // Clear new key input
                elements.newMetadataKeyInput.classList.add('hidden'); // Hide new key input
                elements.newMetadataKeySelect.classList.remove('hidden'); // Show select
                elements.newMetadataValueInput.value = ''; // Clear value input
            }

            // NEW: Function to open modal for editing document metadata
            function openEditDocumentModal(docId) {
                editingDocId = docId;
                const docToEdit = loadedDocuments.find(doc => doc.id === docId);

                if (!docToEdit) {
                    showToast('Documento no encontrado para editar.', true);
                    return;
                }

                // Set modal title and button text for editing
                elements.documentModalTitle.textContent = 'Editar Metadata del Documento';
                elements.confirmAddDocumentBtn.textContent = 'Guardar Cambios';

                // Hide file input, show document name display
                elements.documentFileInputGroup.classList.add('hidden');
                elements.documentNameDisplayGroup.classList.remove('hidden');
                elements.documentNameDisplay.value = docToEdit.name;

                // Populate current metadata
                currentDocumentMetadata = { ...docToEdit.metadata }; // Deep copy
                renderMetadataChips();
                populateMetadataKeySelect(); // Repopulate dropdown with existing keys

                // Reset metadata input fields in case they were left in 'new-metadata-key' mode
                resetMetadataInput();

                elements.addDocumentModal.classList.remove('hidden');
            }

            // NEW: Function to reset the modal state (for new document creation)
            function resetDocumentModalForNew() {
                editingDocId = null;
                elements.documentModalTitle.textContent = 'Agregar Nuevo Documento';
                elements.confirmAddDocumentBtn.textContent = 'Agregar Documento';

                // Show file input, hide document name display
                elements.documentFileInputGroup.classList.remove('hidden');
                elements.documentNameDisplayGroup.classList.add('hidden');
                elements.newDocumentFileInput.value = ''; // Clear file input

                currentDocumentMetadata = {}; // Reset metadata for new document
                renderMetadataChips(); // Clear chips
                populateMetadataKeySelect(); // Repopulate dropdown
                resetMetadataInput(); // Reset metadata input fields
            }

            // Event Listeners for Left Sidebar Main Navigation
            if (elements.navGestionUsuarios) elements.navGestionUsuarios.addEventListener('click', (e) => { e.preventDefault(); activateMainPanel('panel-gestion-usuarios'); });
            if (elements.navGestionDocumentosNuevo) elements.navGestionDocumentosNuevo.addEventListener('click', (e) => { e.preventDefault(); activateMainPanel('panel-gestion-documentos-nuevo'); }); // NEW
            if (elements.navChatearBot) elements.navChatearBot.addEventListener('click', (e) => { e.preventDefault(); activateMainPanel('panel-chatear-bot'); });

            // Event Listener for Settings Icon in Header (now with dropdown functionality)
            if (elements.settingsIconToggle) {
                elements.settingsIconToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    elements.settingsDropdownMenu.classList.toggle('active');
                });
            }

            // Event Listeners for Settings Dropdown items
            if (elements.dropdownProfile) elements.dropdownProfile.addEventListener('click', (e) => {
                e.preventDefault();
                showToast('Navegar a Perfil (Funcionalidad no implementada).', false);
                elements.settingsDropdownMenu.classList.remove('active');
            });
            if (elements.dropdownConfiguracion) elements.dropdownConfiguracion.addEventListener('click', (e) => {
                e.preventDefault();
                activateMainPanel('panel-configuracion');
                activateSettingsSubPanel('general'); // Activate the first sub-tab of settings
            });
            if (elements.dropdownLogout) elements.dropdownLogout.addEventListener('click', (e) => {
                e.preventDefault();
                showToast('Cerrar sesi√≥n (Funcionalidad no implementada).', false);
                elements.settingsDropdownMenu.classList.remove('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (elements.settingsDropdownMenu && elements.settingsDropdownMenu.classList.contains('active') && !elements.settingsDropdownMenu.contains(e.target) && e.target !== elements.settingsIconToggle) {
                    elements.settingsDropdownMenu.classList.remove('active');
                }
            });

            // Event Listeners for Settings Sub-panels (horizontal tabs - existing)
            if (elements.settingsSubTabs.general) elements.settingsSubTabs.general.addEventListener('click', (e) => { e.preventDefault(); activateSettingsSubPanel('general'); });
            if (elements.settingsSubTabs.usuarios) elements.settingsSubTabs.usuarios.addEventListener('click', (e) => { e.preventDefault(); activateSettingsSubPanel('usuarios'); });
            if (elements.settingsSubTabs.modelos) elements.settingsSubTabs.modelos.addEventListener('click', (e) => { e.preventDefault(); activateSettingsSubPanel('modelos'); });
            if (elements.settingsSubTabs.ingesta) elements.settingsSubTabs.ingesta.addEventListener('click', (e) => { e.preventDefault(); activateSettingsSubPanel('ingesta'); });
            if (elements.settingsSubTabs.webScraping) elements.settingsSubTabs.webScraping.addEventListener('click', (e) => { e.preventDefault(); activateSettingsSubPanel('webScraping'); });

            // NEW: Event Listeners for Document Management Sub-panels (horizontal tabs)
            if (elements.docSubTabs.upload) elements.docSubTabs.upload.addEventListener('click', (e) => { e.preventDefault(); activateDocSubPanel('upload'); });
            if (elements.docSubTabs.webScraping) elements.docSubTabs.webScraping.addEventListener('click', (e) => { e.preventDefault(); activateDocSubPanel('webScraping'); });

            // Left Sidebar Toggle
            elements.toggleLeftSidebarButton.addEventListener('click', () => {
                elements.leftSidebar.classList.toggle('collapsed');
                elements.toggleIconOpen.classList.toggle('hidden');
                elements.toggleIconClose.classList.toggle('hidden');
            });

            // Model Whitelisting event listeners
            if (elements.modelWhitelistingToggle) elements.modelWhitelistingToggle.addEventListener('change', renderModelWhitelist);
            if (elements.addModelToWhitelistButton) elements.addModelToWhitelistButton.addEventListener('click', () => {
                elements.addModelModal.classList.remove('hidden');
                elements.newModelInput.focus();
            });
            if (elements.cancelAddModelButton) elements.cancelAddModelButton.addEventListener('click', () => {
                elements.addModelModal.classList.add('hidden');
                elements.newModelInput.value = '';
            });
            if (elements.confirmAddModelButton) elements.confirmAddModelButton.addEventListener('click', addModelToWhitelist);

            // NEW: Add New Document Modal Logic
            if (elements.addNewDocumentBtn) {
                elements.addNewDocumentBtn.addEventListener('click', () => {
                    resetDocumentModalForNew(); // Reset modal for adding new document
                    elements.addDocumentModal.classList.remove('hidden');
                    elements.newDocumentFileInput.focus(); // Focus on file input
                });
            }

            if (elements.cancelAddDocumentBtn) {
                elements.cancelAddDocumentBtn.addEventListener('click', () => {
                    elements.addDocumentModal.classList.add('hidden');
                    resetDocumentModalForNew(); // Reset state when canceling
                });
            }

            if (elements.confirmAddDocumentBtn) {
                elements.confirmAddDocumentBtn.addEventListener('click', () => {
                    if (editingDocId !== null) {
                        // Editing existing document
                        const docIndex = loadedDocuments.findIndex(doc => doc.id === editingDocId);
                        if (docIndex !== -1) {
                            loadedDocuments[docIndex].metadata = { ...currentDocumentMetadata };
                            // Update description if it's based on metadata
                            loadedDocuments[docIndex].description = Object.keys(currentDocumentMetadata).map(key => `${key}: ${currentDocumentMetadata[key]}`).join(', ') || 'Sin descripci√≥n';
                            showToast(`Metadata del documento "${loadedDocuments[docIndex].name}" actualizada.`, false);
                        }
                    } else {
                        // Adding new document
                        const file = elements.newDocumentFileInput.files[0];

                        if (!file) {
                            showToast('Por favor, selecciona un archivo.', true);
                            return;
                        }

                        // Use file name as default name and a summary of metadata as description
                        const docName = file.name;
                        let docDescription = 'Sin descripci√≥n';
                        if (Object.keys(currentDocumentMetadata).length > 0) {
                            docDescription = Object.keys(currentDocumentMetadata).map(key => `${key}: ${currentDocumentMetadata[key]}`).join(', ');
                        }

                        loadedDocuments.push({
                            id: Date.now() + Math.random(),
                            name: docName,
                            description: docDescription,
                            metadata: { ...currentDocumentMetadata }, // Store a copy of the metadata object
                            status: 'active', // New documents are active by default
                            file: file // Store file object if needed for later processing
                        });
                        showToast(`Documento "${docName}" agregado.`, false);
                    }
                    renderLoadedDocuments();
                    elements.addDocumentModal.classList.add('hidden');
                    resetDocumentModalForNew(); // Reset state after saving
                });
            }

            // Logic for metadata key selector and input
            if (elements.newMetadataKeySelect) {
                elements.newMetadataKeySelect.addEventListener('change', () => {
                    if (elements.newMetadataKeySelect.value === 'new-metadata-key') {
                        elements.newMetadataKeyInput.classList.remove('hidden');
                        elements.newMetadataKeySelect.classList.add('hidden');
                        elements.newMetadataKeyInput.focus();
                    } else {
                        // If any other option (including the placeholder) is selected, hide the input and show the select
                        elements.newMetadataKeyInput.classList.add('hidden');
                        elements.newMetadataKeySelect.classList.remove('hidden');
                        elements.newMetadataKeyInput.value = ''; // Clear the input field
                    }
                });
            }

            // Add metadata button
            if (elements.addMetadataBtn) {
                elements.addMetadataBtn.addEventListener('click', addMetadataChip);
            }

            // NEW: Reset metadata input button
            if (elements.resetMetadataInputBtn) {
                elements.resetMetadataInputBtn.addEventListener('click', resetMetadataInput);
            }

            // NEW: Document Filter Logic
            if (elements.documentFilterInput) {
                elements.documentFilterInput.addEventListener('keyup', renderLoadedDocuments);
            }

            // NEW: Toggle Selection Mode Button
            if (elements.toggleSelectionModeBtn) {
                elements.toggleSelectionModeBtn.addEventListener('click', () => {
                    selectionMode = !selectionMode; // Toggle the mode
                    renderLoadedDocuments(); // Re-render to show/hide checkboxes

                    if (selectionMode) {
                        elements.toggleSelectionModeBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <span>Cancelar Selecci√≥n</span>
                        `;
                        elements.applyChangesBtn.classList.remove('hidden');
                        elements.addNewDocumentBtn.classList.add('hidden'); // Hide Add button in selection mode
                    } else {
                        elements.toggleSelectionModeBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Seleccionar Documentos</span>
                        `;
                        elements.applyChangesBtn.classList.add('hidden');
                        elements.addNewDocumentBtn.classList.remove('hidden'); // Show Add button
                    }
                });
            }

            // NEW: Apply Changes Button (for activating/deactivating selected docs)
            if (elements.applyChangesBtn) {
                elements.applyChangesBtn.addEventListener('click', () => {
                    const selectedCheckboxes = elements.loadedDocumentsList.querySelectorAll('.document-select-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        showToast('Por favor, selecciona al menos un documento para aplicar cambios.', true);
                        return;
                    }

                    selectedCheckboxes.forEach(checkbox => {
                        const docId = parseInt(checkbox.dataset.docId);
                        const docIndex = loadedDocuments.findIndex(doc => doc.id === docId);
                        if (docIndex !== -1) {
                            // Toggle status: if active, make inactive; if inactive, make active
                            loadedDocuments[docIndex].status = loadedDocuments[docIndex].status === 'active' ? 'inactive' : 'active';
                        }
                    });

                    selectionMode = false; // Exit selection mode
                    renderLoadedDocuments(); // Re-render to reflect status changes and hide checkboxes

                    // Reset button states
                    elements.toggleSelectionModeBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Seleccionar Documentos</span>
                    `;
                    elements.applyChangesBtn.classList.add('hidden');
                    elements.addNewDocumentBtn.classList.remove('hidden'); // Show Add button
                    showToast('Cambios aplicados a los documentos seleccionados.', false);
                });
            }

            // NEW: Web Scraping action
            if (elements.startScrapingBtn) {
                elements.startScrapingBtn.addEventListener('click', () => {
                    const url = elements.webScrapingUrl.value.trim();
                    const depth = elements.webScrapingDepth.value;
                    const includeImages = elements.includeImages.checked;

                    if (url) {
                        console.log(`Iniciando scrapeo de: ${url}, Profundidad: ${depth}, Incluir im√°genes: ${includeImages}`);
                        // Here you would typically send this information to a backend for scraping
                        showToast(`Iniciando scrapeo de "${url}"...`, false);
                    } else {
                        showToast('Por favor, introduce una URL para iniciar el scrapeo.', true);
                    }
                });
            }


            // Global Save/Reset
            elements.saveButton.addEventListener('click', saveConfiguration);
            elements.resetButton.addEventListener('click', resetToDefaults);

            // Initial setup
            resetToDefaults(); // This will now also render the initial loaded documents
            // Start on the NEW Gesti√≥n de Documentos panel and its Carga de Documentos sub-tab by default
            activateMainPanel('panel-gestion-documentos-nuevo');
            activateDocSubPanel('upload');
            showToast('Valores predeterminados cargados.', false);
        });
    </script>

</body>
</html>
